openapi: 3.0.4
info:
  title: Concert Reservation API
  version: 1.0.0
  description: |
    콘서트 예약 서비스 전체 API 명세.
    인증, 대기열 토큰, 임시 배정(TTL), 결제 트랜잭션, 동시성 오류 등을 모두 포함한 스펙.

servers:
  - url: https://localhost:8080.v1.api.concert.com
  - url: https://localhost:8080.dev.v1.api.concert.com

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    ErrorResponse:
      type: object
      properties:
        timestamp:
          type: string
          example: 2025-10-12T10:23:00
        status:
          type: integer
          example: 409
        error:
          type: string
          example: CONFLICT
        message:
          type: string
          example: 이미 예약된 좌석입니다.
        path:
          type: string
          example: /concert/reserve

    QueueToken:
      type: object
      properties:
        token:
          type: string
          example: QTK-20251010-001
        status:
          type: string
          enum: [WAITING, ACTIVE, EXPIRED]
        expiresAt:
          type: string
          example: 2025-10-10T10:05:00

    Wallet:
      type: object
      properties:
        userId:
          type: string
        balance:
          type: integer
        currency:
          type: string
          example: POINT

    Schedule:
      type: object
      properties:
        scheduleId:
          type: string
          example: SCH-20251012
        date:
          type: string
          example: 2025-10-12
        availableSeats:
          type: integer
          example: 45

    Seat:
      type: object
      properties:
        seatId:
          type: integer
        status:
          type: string
          enum: [AVAILABLE, TEMPHOLD, RESERVED]

    TemporaryReservation:
      type: object
      properties:
        reservationId:
          type: string
          example: RSV-20251010-003
        status:
          type: string
          example: TEMPORARY
        expiresAt:
          type: string
          example: 2025-10-10T10:05:00

    PaymentResult:
      type: object
      properties:
        paymentId:
          type: string
        status:
          type: string
          enum: [SUCCESS, FAILED]
        remainingBalance:
          type: integer
        message:
          type: string

security:
  - BearerAuth: []

paths:

  ##############################
  # 1) 로그인
  ##############################
  /auth/login:
    post:
      summary: 로그인 & queueToken 발급
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                id:
                  type: string
                password:
                  type: string
                deviceId:
                  type: string
                  example: DEVICE-XYZ123
      responses:
        '200':
          description: 로그인 성공 + queueToken 발급
          content:
            application/json:
              schema:
                type: object
                properties:
                  accessToken:
                    type: string
                    example: eyJhbGciOiJIUzI1...
                  refreshToken:
                    type: string
                  queueToken:
                    $ref: '#/components/schemas/QueueToken'
        '401':
          description: 인증 실패
          content: { application/json: { schema: { $ref: '#/components/schemas/ErrorResponse' }}}
        '423':
          description: 계정 잠김
          content: { application/json: { schema: { $ref: '#/components/schemas/ErrorResponse' }}}
        '429':
          description: 로그인 시도 과도 → Rate-limit
          content: { application/json: { schema: { $ref: '#/components/schemas/ErrorResponse' }}}

  ##############################
  # 2) 지갑 조회
  ##############################
  /wallet/{userId}:
    get:
      summary: 지갑 포인트 조회
      security:
        - BearerAuth: []
      parameters:
        - in: path
          name: userId
          required: true
          schema:
            type: string
      responses:
        '200':
          description: 조회 성공
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Wallet'
        '404':
          description: 사용자 없음
          content: { application/json: { schema: { $ref: '#/components/schemas/ErrorResponse' }}}
        '500':
          description: 서버 오류(DB/Redis)
          content: { application/json: { schema: { $ref: '#/components/schemas/ErrorResponse' }}}

  ##############################
  # 3) 충전
  ##############################
  /wallet/recharge:
    post:
      summary: 포인트 충전
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                userId: { type: string }
                amount: { type: integer }
                paymentMethod:
                  type: string
                  example: PG_CARD
                pgTransactionId:
                  type: string
                  example: PG-123123
      responses:
        '200':
          description: 충전 성공
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Wallet'
        '400':
          description: 유효하지 않은 충전 금액
          content: { application/json: { schema: { $ref: '#/components/schemas/ErrorResponse' }}}
        '409':
          description: 결제 성공했으나 지갑 업데이트 실패
          content: { application/json: { schema: { $ref: '#/components/schemas/ErrorResponse' }}}
        '500':
          description: PG 연동 실패

  ##############################
  # 4) 날짜 조회
  ##############################
  /concert/schedules:
    get:
      summary: 예약 가능한 콘서트 날짜 조회
      responses:
        '200':
          description: 성공
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Schedule'
        '500':
          description: 조회 실패

  ##############################
  # 5) 좌석 조회
  ##############################
  /concert/{scheduleId}/seats:
    get:
      summary: 예약 가능한 좌석 조회
      parameters:
        - in: path
          name: scheduleId
          required: true
          schema:
            type: string
      responses:
        '200':
          description: 성공
          content:
            application/json:
              schema:
                type: array
                items: { $ref: '#/components/schemas/Seat' }
        '404':
          description: 스케줄 없음
        '500':
          description: 서버 오류

  ##############################
  # 6) 좌석 임시 예약 (TTL 5분)
  ##############################
  /concert/reserve:
    post:
      summary: 좌석 임시 예약(5분간)
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                userId: { type: string }
                scheduleId: { type: string }
                seatId: { type: integer }
                queueToken: { type: string }
      responses:
        '200':
          description: 임시 예약 성공
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TemporaryReservation'
        '400':
          description: 잘못된 요청(좌석 번호 범위 등)
        '401':
          description: queueToken 인증 실패
        '403':
          description: queueToken 상태가 ACTIVE가 아님
        '409':
          description: 좌석 충돌(이미 임시 배정됨)
        '410':
          description: queueToken 만료
        '500':
          description: TTL/Lock 설정 실패

  ##############################
  # 7) 결제 (최종 확정)
  ##############################
  /payment/confirm:
    post:
      summary: 좌석 결제 및 확정
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                userId: { type: string }
                reservationId: { type: string }
                amount: { type: integer }
                queueToken: { type: string }
      responses:
        '200':
          description: 결제 성공
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PaymentResult'
        '401':
          description: 인증 실패
        '402':
          description: 포인트 부족
        '403':
          description: 임시예약 상태 아님
        '404':
          description: 예약 ID 없음
        '409':
          description: TTL 만료 / 좌석 충돌
        '500':
          description: 결제 트랜잭션 실패
